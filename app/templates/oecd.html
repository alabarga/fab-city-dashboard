{% extends "base.html" %} {% block content %}

<h2><span id="title"></span> - <span id="subtitle"></span></h2>

<svg width="960" height="500" style="border: 1px solid black;"></svg>

<script>
    d3.json("regional-data", function(data) {

        // Debug
        console.log(data[0]);

        // Change title
        d3.select("body").select("#title").text(data[0]["Country"]);
        d3.select("body").select("#subtitle").text(data[0]["Region"]);

        // Colors for the resilience metrics
        var resilience_colors = {
            "Housing": "#16785D",
            "Income": "#22357C",
            "Jobs": "#1A5774",
            "Community": "#67A61E",
            "Environment": "#1A9022",
            "Education": "#551C7B",
            "Civic engagement": "#7A1676",
            "Work life balance": "#A81E3E",
            "Life satisfaction": "#E62339",
            "Safety": "#B78621",
            "Health": "#B74021",
            "Accessibility to services": "#B7B721"
        };

        // Nesting countries
        var countries = d3.nest()
            .key(function(d) {
                return d["Country"];
            })
            .entries(data);

        // Nesting regions
        var regions = d3.nest()
            .key(function(d) {
                return d["Region"];
            })
            .entries(data);

        // A single region: delete
        console.log(regions[0]["key"])
        var region_data = regions[0]["values"][0];
        delete region_data["Region"];
        delete region_data["Region Code"];
        delete region_data["Country"];

        var region_array = [];
        var region_object = {}

        for (var property in region_data) {
            if (property != "Region" && property != "Region Code" && property != "Country") {
                //region_object[property] = parseFloat(region_data[property]);
                test = {}
                test[property] = parseFloat(region_data[property]);
                region_array.push(test);
            }

        }


        // variables
        var zerox = 10;
        var zeroy = 10;
        var width = 300;
        var barHeight = 13;
        var space_between_bars = 25;
        var legend_width = 180;

        // Linear scale for scaling the graph
        var linearScale = d3.scaleLinear()
            .domain([0, 10])
            .range([0, width]);

        // Access svg area
        var svg = d3.select("svg")
            .attr("width", width * 3.5)
            .attr("height", space_between_bars * region_array.length + zeroy);

        // Rounded bars
        var bar = svg.selectAll("g")
            .data(region_array)
            .enter()
            .append("g")


        // The bars
        bar.append("rect")
            .attr("x", zerox + legend_width)
            .attr("y", function(d, i) {
                return zeroy + i * 25;
            })
            .attr("width", function(d) {
                for (property in d) {
                    var resilience_value = d[property];
                }
                return linearScale(resilience_value);
            })
            .attr("height", barHeight)
            .attr("rx", 6)
            .attr("ry", 6)
            .attr("fill", function(d) {
                for (property in d) {
                    var the_color = resilience_colors[property];
                }
                return the_color;
            });

        // The legend labels
        bar.append("text")
            .attr("x", zerox)
            .attr("y", function(d, i) {
                return zeroy + 6 + i * 25;
            })
            .attr("dy", ".35em")
            .text(function(d) {
                for (property in d) {
                    var label_text = property;
                }
                return label_text;
            });

        // The value labels
        bar.append("text")
            .text(function(d) {
                for (property in d) {
                    var label_value = d[property];
                }
                return label_value + "/10";
            })
            .attr("x", function(d) {
                for (property in d) {
                    var label_value = d[property];
                }
                return zerox + legend_width + zerox + linearScale(label_value);
            })
            .attr("y", function(d, i) {
                return zeroy + barHeight - 2 + i * space_between_bars;
            });

    });
</script>

{% endblock %}
